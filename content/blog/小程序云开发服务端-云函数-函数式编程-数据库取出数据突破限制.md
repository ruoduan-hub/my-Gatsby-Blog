---
title: å°ç¨‹åºäº‘å¼€å‘æœåŠ¡ç«¯(äº‘å‡½æ•°-å‡½æ•°å¼ç¼–ç¨‹)æ•°æ®åº“å–å‡ºæ•°æ®çªç ´é™åˆ¶
date: 2019-11-14
tags: web-other
categories: ã€Šweb-otherã€‹
---

> è·å–é›†åˆä¸­çš„æ‰€æœ‰å¾…åŠäº‹é¡¹æ¸…å•ï¼šå› ä¸ºæœ‰é»˜è®¤ limit 100 æ¡çš„é™åˆ¶ï¼Œå› æ­¤å¾ˆå¯èƒ½ä¸€ä¸ªè¯·æ±‚æ— æ³•å–å‡ºæ‰€æœ‰æ•°æ®ï¼Œéœ€è¦åˆ†æ‰¹æ¬¡å–ï¼š

### æ­¥éª¤

1. å®šä¹‰æœ€å¤§æ¡æ•°ä¹Ÿå°±æ˜¯ ä¸‹é¢ ğŸ‘‡ ç¤º ğŸŒ° ä¸­çš„ `MAX_LIMIT`
2. è·å–æ•°æ®æ€»æ¡æ•° `countResult.total`
3. æ€»æ¡æ•° / MAX_LIMIT æƒ³ä¸Šå–æ•´è®¡ç®—å‡º è¦å–å‡ æ¬¡ `batchTimes`
4. å…³é”®æ­¥éª¤ï¼š
   - éå†`batchTimes` åˆ©ç”¨`skip()` å‘æ•°æ®åº“å–å¯¹åº”æ¬¡æ•°çš„æ•°æ®
   - è¿”å›çš„è‹¥å¹²çš„`Promise` å‚¨å­˜åœ¨ `tasks`æ•°ç»„ä¸­
5. åˆ›å»ºå‚¨å­˜æ•°æ®çš„åˆ—è¡¨ `data`
6. ç»„åˆæ•°æ®
   - `Promise.all(tasks)`
   - `reduce((acc, cur)` ç»„åˆæ•°æ®

## æ³¨æ„ âš ï¸ï¼š æ•°æ®æ“ä½œå¤§éƒ¨åˆ†éƒ½æ˜¯å¼‚æ­¥æ“ä½œï¼›å°ç¨‹åºçš„äº‘å¼€å‘ç›®å‰ä¹Ÿæ˜¯åŸºäº nodejs8

### å°æ —å­ ğŸŒ°

```js
// äº‘å‡½æ•°å…¥å£æ–‡ä»¶
const cloud = require('wx-server-sdk')
cloud.init()
// åˆå§‹åŒ–äº‘æ•°æ®åº“
const db = cloud.database()
const MAX_LIMIT = 100

exports.main = async (event, context) => {
  // æ•°æ®åº“å¯¹è±¡
  const playCollection = await db.collection("playlist")
  // æ•°æ®åº“é›†åˆæ€»æ•°
  const countResult = await db.collection('playlist').count()
  const total = countResult.total
  // è®¡ç®—éœ€åˆ†å‡ æ¬¡å–
  const batchTimes = Math.ceil(total / 100)
  // æ‰¿è½½æ‰€æœ‰è¯»æ“ä½œçš„ promise çš„æ•°ç»„
  const tasks = []
  for (let i = 0; i < batchTimes; i++) {
    const promise = db.collection('playlist').skip(i * MAX_LIMIT).limit(MAX_LIMIT).get()
    tasks.push(promise)
  }

  let data = {
    data: []
  }
  // ç»„åˆæ•°æ®
  if (tasks.length > 0) {
    (await Promise.all(tasks)).reduce((acc, cur) => {
      return {
        data: acc.data.concat(cur.data),
      }
    })
  }

```
